/* Magos Editor */$(function(){(function(e,t,n,r){"use strict";function l(){var n=t(".slider-tooltip");n.hide();var r=e.selectedComponentController.getPath("content.properties.gravitation.strength")?e.selectedComponentController.getPath("content.properties.gravitation.strength"):0;t("#gravitationStrength").slider({min:0,max:10,step:1,value:parseFloat(r)*10,start:function(e,t){n.fadeIn("fast")},slide:function(e,r){var i=r.value/10,s=t(this).slider("value");t(".gravitationStrengthVal").val(i);n.css("left",r.value*10+"%").text(i)},stop:function(e,t){n.fadeOut("slow")}})}function c(n){n.sortable({placeholder:"sortable-highlight",items:"> .sortable-item",handle:"h3",axis:"y",opacity:.8,forceHelperSize:!0});n.disableSelection();setTimeout(function(){t(".potion-icon").draggable("destroy");t(".selected-magos .potion-icon").draggable({helper:"clone"});var r=n.find(".magos-potions:not(.selected-magos)").find(".skillset");r.droppable({greedy:!0,accept:".skillset-icon",activeClass:"ui-state-hover",hoverClass:"ui-state-active",drop:function(n,r){var i=t(n.target),s=t(r.draggable),o=s.data("magos"),u=i.find(".skillset-icon").data("magos"),a=e.usersController.get("user"),f=e.gameController.getPath("content.slug");e.dataSource.canUserChangeMagos(f,a,u,function(t){console.log("emit (can user change magos)");if(t){console.log("can change magos");e.magosesController.set("selected",u);e.usersController.set("user.magos",u);e.dataSource.userChangedMagos(a,u,function(e){console.log("emit (user changed magos)")})}else{console.log("cannot change magos");e.setFlash("error","Can not change Magos")}})}});var i=n.find(".magos-potions.selected-magos").find(".skillset").find(".skillset-icon");i.draggable({helper:"clone",cursor:"move",zIndex:9999})},400)}function h(n){var r=n=="gameComponents"?"canvas-game-component":"canvas-scene-component";t(".canvas-pane").on("click tap","img."+r,function(r){var i=t(r.target),s=i.data("oid"),o=e.scenesController.getPath("selected."+n).findProperty("oid",s);console.log("REMOVABLE ITEM:");console.log(o);e.scenesController.getPath("selected."+n).removeObject(o);i.remove();e.dataSource.saveGame(0,function(t){console.log("save (click)");var n=e.scenesController.get("selected").get("name");e.dataSource.removeGameComponentFromCanvas(o,n,function(e){console.log("emit (remove game component from game canvas")})})})}function p(){var e=t(".selected-magos");e.is(":hidden")&&e.siblings(".magos-potion-form:visible").hide("slide",{direction:"left"},250,function(){e.show("slide",{direction:"right"},250)})}function d(){t(".canvas-cell").empty();var n=e.gameController.getPath("content.revision.scenes");_.each(n,function(n){var r=n.get("gameComponents"),i=t(".canvas-"+n.name);_.each(r,function(n){var r=n.position.row,s=n.position.column,o=n.slug,u=n.oid,a=null,f=null,l=null,c=null;if(e.gameController.getPath("content.revision.gameComponents").findProperty("slug",o)){a=e.gameController.getPath("content.revision.gameComponents").findProperty("slug",o).get("properties.sprite");f=e.gameController.getPath("content.revision.gameComponents").findProperty("slug",o).get("properties.file");l=e.gameController.getPath("content.revision.gameComponents").findProperty("slug",o).get("extension");c=e.gameController.getPath("content.revision.gameComponents").findProperty("slug",o).get("icon");var h='<img src="'+c+'" data-slug="'+o+'" data-oid="'+u+'" class="canvas-item canvas-game-component">',p=t(h),d=r+1,v=s+1;i.find("tr:nth-child("+d+")").find("td:nth-child("+v+")").append(p)}})});h("gameComponents")}function v(){var n=null,r=setInterval(function(){var n=e.gameController.getPath("content.revision.canvas");if(n!==null){clearInterval(r);var i=t(".canvas-game"),s=t(".canvas-pane"),o=n.rows,u=n.columns,a="size-"+n.blockSize,f="";for(var l=0;l<o;l+=1){f+="<tr>";for(var c=0;c<u;c+=1)f+='<td class="canvas-cell"></td>';f+="</tr>"}var h=u*n.blockSize,p=o*n.blockSize,v={"max-width":h+"px",height:p+"px"};t.each(s,function(e,n){t(this).css(v)});t(".scene-chest").addClass(a);t(".item-chest").addClass(a);i.addClass(a).append(f);d();b();m()}},10)}function m(){t(".canvas-cell").bind("resize",function(e){var n=t(e.target),r=n.width();n.css({height:r+" !important"})});var e=t(".canvas-pane"),n=e.height()/e.width()}function g(n,r){var i="gameComponents",s=i=="gameComponents"?"canvas-game-component":"canvas-scene-component",o=t(".canvas-"+r),u=n.position.row,a=n.position.column,f=u+1,l=a+1,c=o.find("tr:nth-child("+f+")").find("td:nth-child("+l+") img"),h=n.oid,p=e.scenesController.get("content").findProperty("name",r).get("gameComponents").findProperty("oid",h);e.scenesController.get("content").findProperty("name",r).get("gameComponents").removeObject(p);c.remove()}function y(n,r){var i=t(".canvas-"+r),s=n.position.row,o=n.position.column,u=s+1,a=o+1,f=i.find("tr:nth-child("+u+")").find("td:nth-child("+a+")");if(!f.is(":empty"))return!1;var l=n.slug,c=n.oid,h=null,p=null,d=null,v=null;if(e.gameController.getPath("content.revision.gameComponents").findProperty("slug",l)){h=e.gameController.getPath("content.revision.gameComponents").findProperty("slug",l).get("properties.sprite");p=e.gameController.getPath("content.revision.gameComponents").findProperty("slug",l).get("properties.file");d=e.gameController.getPath("content.revision.gameComponents").findProperty("slug",l).get("extension");v=e.gameController.getPath("content.revision.gameComponents").findProperty("slug",l).get("icon");var m='<img src="'+v+'" data-slug="'+l+'" data-oid="'+c+'" class="canvas-item canvas-game-component">',g=t(m),y=e.CanvasComponent.create(n);e.scenesController.get("content").findProperty("name",r).get("gameComponents").pushObject(y);g.data("oid",n.oid);f.append(g)}}function b(){t(".canvas-cell").droppable({greedy:!0,accept:".game-item",activeClass:"canvas-cell-hover",hoverClass:"canvas-cell-active",drop:function(n,r){var i=t(this);if(!i.is(":empty"))return!1;var s=t(r.draggable),o="",u=s.data("slug");s.hasClass("game-item")?o=s.clone().removeAttr("data-original-title rel alt class style").addClass("canvas-item canvas-game-component"):o=s.removeAttr("data-original-title rel alt class style").addClass("canvas-item canvas-game-component");var a=i.closest("tr"),f=a.find("td").index(i),l=a.closest("table").find("tr").index(a),c=u+f+l,h=e.CanvasComponent.create({oid:c,slug:u,position:{column:f,row:l}});e.scenesController.getPath("selected.gameComponents").pushObject(h);o.attr({"data-oid":c});o.data("oid",c);i.append(o);e.dataSource.saveGame(0,function(t){console.log("save game component (drop)");var n=e.scenesController.get("selected").get("name");e.dataSource.saveGameComponentToCanvas(h,n,function(e){console.log("emit (save game component (drop))")})})}});t(".canvas-pane").droppable({greedy:!0,accept:".scene-item, .canvas-item",activeClass:"canvas-hover",hoverClass:"canvas-active",drop:function(n,r){var i=r.position,s=r.offset,o=t(this).offset(),u=parseInt(s.left-o.left,10),a=parseInt(s.top-o.top,10),f={top:a,left:u,position:"absolute"},l=t(r.draggable),c=t(this),h={},p=l.data("slug");if(l.hasClass("cloned"))h=l;else{h=l.clone().removeAttr("data-original-title rel alt class style ui-draggable").addClass("canvas-item cloned");h.css(f)}h.addClass("canvas-scene-component");c.append(h);var d=h.position(),v=Math.round(d.left),m=Math.round(d.top),g=p+v+m;h.attr({id:g});var y={oid:g,slug:p,position:{left:v,top:m}};console.log(y);e.scenesController.getPath("selected.sceneComponents").pushObject(y);e.dataSource.saveGame(1,function(t){console.log("save scene component (drop)");var n=e.scenesController.get("selected").get("name");e.dataSource.saveSceneComponentToCanvas(y,n,function(e){console.log("emit (save scene component (drop))")})})}})}e.VERSION="0.0.1",e.settings={djangoUri:"http://10.0.1.5:8000/"};e.NumberField=n.TextField.extend({attributeBindings:["min","max"],type:"number"});e.DecimalNumberField=n.TextField.extend({attributeBindings:["name","min","max","step"],type:"number"});e.HiddenDecimalNumberField=n.TextField.extend({attributeBindings:["name","min","max","step"],type:"hidden"});e.ColorField=n.TextField.extend({type:"color"});e.User=n.Object.extend({userName:null,firstName:null,lastName:null,magos:null,busy:!1,role:"student"});e.usersController=n.ArrayController.create({content:[],user:null,removeItem:function(e,t){var n=this.findProperty(e,t);this.removeObject(n)}});e.Room=n.Object.extend({slug:null,authors:null,teachers:null,magosesBinding:"App.magosesController.content",init:function(){this._super();this.set("authors",[]);this.set("teachers",[])}});e.roomController=n.Object.create({content:null,populate:function(t){var n=this;console.log("POPULATE ROOM");console.log(t);e.dataSource.joinRoom(t,function(t){console.log(t);if(_.isObject(t)){console.log("User joined room.");var r=e.Room.create(t);n.set("content",r);var i=e.usersController.get("user");_.each(t.magoses,function(t){var n=e.Magos.create(t);if(n.get("user")){if(i.userName==n.get("user").userName){console.log("Set magos "+n.get("magos")+" for active user "+i.userName);i.set("magos",n.get("magos"))}var r=e.User.create(t.user);n.set("user",r)}var s=[];_.each(t.potions,function(t){var n=e.Potion.create(t);s.push(n);e.potionsController.get("content").pushObject(n)});n.set("potions",s);e.magosesController.get("content").pushObject(n)});e.dataSource.addUser(i,function(e){console.log("emit (add user AGAIN)")});e.magosesController.populate()}else{console.log("Not authorized.");window.location.replace(e.settings.djangoUri)}})}});e.Game=n.Object.extend({title:"Magos",slug:null,type:null,state:0,cloned:0,description:null,authors:[],revision:null,href:null,playPath:function(){return"/play/"+this.get("slug")}.property("playPath")});e.gameController=n.Object.create({content:null,populate:function(){var t=this;e.dataSource.setUserCredentials(function(n){if(n){var r=n.slug,i=e.User.create({userName:n.userName,firstName:n.firstName,lastName:n.lastName,role:n.role});e.usersController.get("content").pushObject(i);var s=e.usersController.get("content").findProperty("userName",n.userName);e.usersController.set("user",s);e.dataSource.addUser(s,function(e){console.log("emit (add user)")});e.dataSource.joinGame(function(n){n.slug=r;console.log("GAME data:");console.log(n);t.set("content",n);e.roomController.populate(n)})}})}});e.GameView=n.View.extend({classNames:["game-preview-view"],playPathBinding:"App.gameController.content.playPath"});e.Revision=n.Object.extend({canvas:[],scenes:[],assets:{},gameComponents:[]});e.revisionController=n.Object.create({contentBinding:"App.gameController.content.revision",canvasObserver:function(){var t=this,n=t.getPath("content.canvas");n&&e.imageAssetsController.populate()}.observes("content")});e.Scene=n.Object.extend({name:null,gameComponents:[],sceneComponents:[],active:!1});e.scenesController=n.ArrayController.create({contentBinding:"App.revisionController.content.scenes",selectedBinding:"App.revisionController.content.scenes.firstObject",gameScenes:[],firstRun:1,init:function(){n.run.next(function(){v()})},selectedObserver:function(){var e=this,r=this.getPath("selected.name"),i=e.get("selected"),s=e.get("content");i&&console.log(i.name);_.each(s,function(e){e.set("active",!1)});_.isNull(i)||i.set("active",!0);r!=="intro"&&r!=="outro"?t("body").addClass("game-scene"):t("body").removeClass("game-scene");this.get("firstRun")<0&&n.run.next(function(){var e=t(".canvas > .canvas-pane:visible");e.fadeOut(250,function(){e.siblings(".canvas-"+r).fadeIn(250)})});this.set("firstRun",this.get("firstRun")-1)}.observes("selected")});e.gameScenesController=n.ArrayController.create({content:[],scenesBinding:n.Binding.oneWay("App.scenesController.content"),scenesObserver:function(){var e=this.get("scenes"),t=[];_.each(e,function(e){e.name!=="intro"&&e.name!=="outro"&&t.push(e)});this.set("content",t)}.observes("scenes")});e.SelectSceneView=n.View.extend({contentBinding:"App.scenesController.content",classNames:["btn-group","btn-group-scene"],alwaysTrue:!0,click:function(r){var i=t(r.target),s=n.View.views[i.parent().attr("id")],o=s.get("item");e.selectedComponentController.set("content",o)}});e.SelectSceneBtn=n.View.extend({classNames:["btn","btn-primary"],classNameBindings:["scene.active"],click:function(t){e.scenesController.set("selected",this.get("scene"))}});e.ImageAsset=n.Object.extend({name:null,slug:null,file:null,ext:null,state:0,type:0,apiPath:function(){var t=e.gameController.get("content").get("revision").canvas,n=parseInt(t.blockSize,10),r=parseInt(t.rows,10),i=parseInt(t.columns,10),s=n,o=n;if(this.get("type")==2){s=i*n;o=r*n}return e.settings.djangoUri+"game/image/"+this.get("file")+"_"+s+"x"+o+"."+this.get("ext")}.property("file")});e.imageAssetsController=n.ArrayController.create({content:null,populate:function(){var t=this;e.dataSource.getImageAssets(function(e){console.log(". . . . image assets data:");console.log(e);t.set("content",e)})},blocks:n.computed(function(){var e=this.get("content"),t=[];_.each(e,function(e){e.type==0&&t.push(e)});return t}).property("content"),animations:n.computed(function(){var e=this.get("content"),t=[];_.each(e,function(e){e.type==1&&t.push(e)});return t}).property("content"),backgrounds:n.computed(function(){var e=this.get("content"),t=[];_.each(e,function(e){e.type==2&&t.push(e)});return t}).property("content")});e.SceneComponent=n.Object.extend({title:null,slug:null,sprite:null,file:null,scenes:[],potions:null,active:!1,icon:function(){return"/editor/static/img/icons/icon-"+this.get("slug")+".png"}.property("slug"),potionsStr:function(){var e=this.get("potions"),t="";_.each(e,function(e){t+="p-"+e+" "});return t.trim()}.property("potions"),scenesStr:function(){var e=this.get("scenes"),t="";_.each(e,function(e){t+="s-"+e+" "});return t.trim()}.property("scenes")});e.CanvasComponent=n.Object.extend({oid:null,slug:null,position:null,properties:null});e.GameComponent=n.Object.extend({title:null,slug:null,file:null,properties:null,active:!1,icon:function(){var t=this.getPath("properties.file"),n=this.get("extension"),r=e.gameController.get("content").get("revision").canvas,i=parseInt(r.blockSize,10),s=parseInt(r.rows,10),o=parseInt(r.columns,10);console.log(n);var u=i,a=i;return e.settings.djangoUri+"game/image/"+t+"_"+u+"x"+a+"."+n}.property("properties.file"),extension:function(){var e=this.getPath("properties.ext");return e}.property("properties.ext"),snapToGrid:function(){var e=this.getPath("properties.controls.grid");return e===!1?"No":e===!0?"Yes":e}.property("properties.controls.grid"),collisions:function(){var e=this.getPath("properties.collisions");return e}.property("properties"),filteredScoreEvents:function(){var e=this.getPath("properties.collisions");return _.isObject(e)?e.filterProperty("score"):!1}.property("properties"),filteredAudioEvents:function(){var e=this.getPath("properties.collisions");return _.isObject(e)?e.filterProperty("audio"):!1}.property("properties"),filteredTextEvents:function(){var e=this.getPath("properties.collisions");return _.isObject(e)?e.filterProperty("text"):!1}.property("properties"),filteredDialogEvents:function(){return!1}.property("properties")});e.selectedScoreTargetController=Ember.Object.create({option:null});e.selectedScoreEventController=Ember.Object.create({option:null});e.gameComponentsController=n.ArrayController.create({contentBinding:"App.gameController.content.revision.gameComponents",removeItem:function(t,n){var r=this.findProperty(t,n);this.removeObject(r);e.dataSource.saveGame(0,function(e){console.log("save (remove game component)")})},refreshCollisionTargets:function(){this.notifyPropertyChange("collisionTargets")},collisionTargets:function(){var t=[],n=null,r=e.selectedComponentController.get("content");r&&(n=e.selectedComponentController.get("content").slug);_.each(e.gameComponentsController.get("content"),function(r){(r.properties.type.toLowerCase()=="collectible"||r.properties.type.toLowerCase()=="player"||r.properties.type.toLowerCase()=="pushable"||r.properties.type.toLowerCase()=="decoration")&&r.slug.toLowerCase()!=n&&t.push(e.GameComponent.create(r))});return t}.property("content.@each"),refreshScoreCollisionTargets:function(){this.notifyPropertyChange("scoreCollisionTargets")},scoreCollisionTargets:function(){var t=[],n=[],r=[],i=this,s=e.selectedComponentController.get("content");if(s)var n=s.getPath("properties.collisions");var o=this.get("selectedScoreTarget");console.log("1. ====>>> selectedScoreTarget: "+o);_.each(n,function(n){var s=e.gameComponentsController.get("content").filterProperty("slug",n.target.slug);if(_.indexOf(r,n.target.slug)==-1){r.push(n.target.slug);(_.isNull(o)||_.isUndefined(o))&&console.log("2. ---->>> selectedScoreTarget: "+i.get("selectedScoreTarget"));t.push(e.GameComponent.create(s[0]))}});return t}.property("content.@each"),selectedScoreTargetObserver:function(){console.log("SELECTED SCORE TARGET CHANGED");var e=this.get("selectedScoreTarget");if(!_.isUndefined(e)&&!_.isNull(e)){console.log("=> CHANGE SCORE TARGET");this.refreshScoreCollisionEvents()}}.observes("selectedScoreTarget"),refreshScoreCollisionEvents:function(){this.notifyPropertyChange("scoreCollisionEvents")},scoreCollisionEvents:function(){var t=[],n=[],r=this,i=e.selectedComponentController.get("content"),s=this.get("selectedScoreTarget"),o=this.get("selectedScoreEvent");if(i)var n=i.getPath("properties.collisions");_.each(n,function(n){if(!_.isUndefined(s)&&n.target.slug==s.slug){(_.isNull(o)||_.isUndefined(o)||o.event!=n.event.title)&&r.set("selectedScoreEvent",n.event);t.push(e.GameComponent.create(n.event))}});return t}.property("content.@each"),updateItem:function(n,r,i){console.log(i);i.active=!1;var s=this.findProperty(n,r),o=i.properties.file,u=i.slug,a=e.GameComponent.create(i),f=this.indexOf(s),l=[];_.each(i.properties.collisions,function(t){var n=e.Collision.create(t);l.push(n)});a.getPath("properties.collisions").set(l);this.replaceContent(f,1,[a]);t(".canvas-pane").find("[data-slug='"+u+"']").attr("src",a.get("icon"))}});e.GameComponentsView=n.View.extend({classNameBindings:["uiSelected"],uiSelected:!1,alwaysTrue:!0,sceneBinding:n.Binding.oneWay("App.scenesController.selected.name"),contentBinding:"App.gameComponentsController.content",sceneObserver:function(){var r=this.get("scene"),i=t(".game-container .item-chest");i.find("li").each(function(r){var i=t(this);if(!i.hasClass("add-item")&&!i.hasClass("remove-item")){i.find("> img").draggable({helper:"clone",snap:".canvas-cell:empty",snapMode:"inner",start:function(){var r=n.View.views[t(this).parent().attr("id")],i=r.get("item");e.selectedComponentController.set("content",i)}});i.droppable({greedy:!0,accept:".potion-icon",activeClass:"ui-state-target",hoverClass:"ui-state-active",drop:function(r,i){var s=t(this),o=n.View.views[s.attr("id")],u=o.get("item");e.selectedComponentController.set("content",u);e.usersController.setPath("user.busy",!0);var a=t(i.draggable),f=a.closest(".magos-potions"),c=a.data("potion"),h=document.querySelector("#potion-sound");h.play();f.hide("slide",{direction:"right"},250,function(){f.siblings(".magos-potions."+c).show("slide",{direction:"left"},250);c=="image"&&t("#image-assets").modal().on("show");c=="gravitation"&&l()})}})}})}.observes("scene"),didInsertElement:function(){var r=this.$();r.find("> img").tooltip({delay:{show:500,hide:100},placement:"top"});var i=this.get("scene");r.find("> img").draggable({helper:"clone",snap:".canvas-cell:empty",snapMode:"inner",start:function(){var r=n.View.views[t(this).parent().attr("id")],i=r.get("item");e.selectedComponentController.set("content",i)}});r.droppable({greedy:!0,accept:".potion-icon",activeClass:"ui-state-target",hoverClass:"ui-state-active",drop:function(r,i){var s=t(this),o=n.View.views[s.attr("id")],u=o.get("item");e.selectedComponentController.set("content",u);e.usersController.setPath("user.busy",!0);var a=t(i.draggable),f=a.closest(".magos-potions"),c=a.data("potion");f.hide("slide",{direction:"right"},250,function(){f.siblings(".magos-potions."+c).show("slide",{direction:"left"},250);c=="image"&&t("#image-assets").modal().on("show");c=="gravitation"&&l()})}})},eventManager:n.Object.create({click:function(t,n){var r=n.get("item");e.selectedComponentController.set("content",r);e.usersController.getPath("user.busy")&&e.usersController.setPath("user.busy",!1);p()}})});e.AddGameComponentView=n.View.extend({click:function(e){t("#dialog-new-item").modal().on("show",function(){t(this).find("input").val("");t(this).find(".control-group").removeClass("error")})},didInsertElement:function(){this.$("> img").tooltip({delay:{show:500,hide:100},placement:"top"})}});e.RemoveGameComponentView=n.View.extend({didInsertElement:function(){var r=this;r.$("> img").tooltip({delay:{show:500,hide:100},placement:"top"});r.$().droppable({greedy:!0,accept:".game-item, .canvas-item",activeClass:"ui-state-target",hoverClass:"ui-state-active",drop:function(r,i){var s=t(i.draggable);if(s.hasClass("canvas-item"))s.remove();else{var o=n.View.views[s.parent().attr("id")],u=o.get("item"),a=u.get("slug");if(!t(".canvas-pane").find("[data-slug='"+a+"']").length){e.gameComponentsController.removeItem("slug",a);e.dataSource.removeGameComponent(a,function(e){console.log("emit (remove game component)")})}else{console.log("Can not remove gameComponent");e.setFlash("error","Can not remove game component. It is in use.")}}}})}});e.Collision=n.Object.extend({event:null,target:null,score:0});n.View.create({templateName:"dialog-new-item"}).appendTo("body");e.AddItemForm=n.View.extend({tagName:"form",classNames:["vertical-form"],itemTitle:null,compType:null,submit:function(n){n.preventDefault();var r=this.get("itemTitle"),i=this.getPath("compType.name");console.log(r+":::"+i);if(!r.length||!i.length)return;var s=w(r);if(!!e.gameController.getPath("content.revision.gameComponents").findProperty("slug",s)){e.setFlash("error","Item name is already in use. Please choose a different name.");return!1}var o={title:r,slug:s,properties:{sprite:"empty1",file:"cc7ec50c-b014-4363-850e-35a8c5e30a6c",ext:"png",type:i}},u=e.GameComponent.create(o);console.log(u.get("properties"));e.gameComponentsController.get("content").pushObject(u);t("#dialog-new-item").modal("hide");e.dataSource.addGameComponent(u,function(e){console.log("emit (add game component)")});e.dataSource.saveGame(1,function(e){console.log("save (create new)")});this.set("itemTitle",null)}});n.View.create({templateName:"dialog-image-assets",click:function(n){n.preventDefault();var r=t(n.target),i=t("#image-assets");if(r.hasClass("btn-select")){var s=i.find(".assets-list").find(".ui-selected");if(!s.length&&!_.isNull(e.selectedComponentController.get("content")))return!1;var o=s.data("type"),u=s.data("sprite"),a=s.data("file"),f=s.data("ext");console.log(f);var l=e.imageAssetsController.get("content").findProperty("file",a);e.selectedComponentController.setPath("content.properties.sprite",u);e.selectedComponentController.setPath("content.properties.file",a);e.selectedComponentController.setPath("content.properties.ext",f);var c=e.selectedComponentController.get("content"),h=e.selectedComponentController.getPath("content.slug"),d=l.get("apiPath");t(".item-chest").find("[data-slug='"+h+"']").attr("src",d);console.log(d);console.log(t(".item-chest").find("[data-slug='"+h+"']"));t(".canvas-pane").find("[data-slug='"+h+"']").attr("src",d);e.dataSource.saveGame(0,function(e){console.log("save (add sprite)")});e.dataSource.updateGameComponent(h,c,function(e){console.log("emit (update game component)")});i.modal("hide");i.find(".ui-selected").removeClass(".ui-selected")}else if(r.hasClass("btn-close")){i.modal("hide");i.find(".ui-selected").removeClass(".ui-selected")}p()},didInsertElement:function(){n.run.next(function(){t(".assets-list").selectable({filter:"li"})})}}).appendTo("body");e.selectedComponentController=n.Object.create({content:null,gameComponentsBinding:"App.gameComponentsController.content",contentObserver:function(){var r=this.get("content"),i=t(".item-chest").find("li");e.gameComponentsController.refreshCollisionTargets();e.gameComponentsController.refreshScoreCollisionTargets();_.each(i,function(e){var i=n.View.views[t(e).attr("id")],s=i.get("item");i.set("uiSelected",s===r?!0:!1)});var s=this.get("gameComponents"),o=s;_.each(o,function(e){e.set("active",!1)});r.set("active",!0);console.log("CONTENT");console.log(r)}.observes("content")});e.potionsController=n.ArrayController.create({content:[],hideJumpHeight:!1,controls:n.computed(function(){var e=this.get("content").findProperty("title","controls").get("properties");return n.Object.create(e)}).property("content"),gravitation:n.computed(function(){var e=this.get("content").findProperty("title","gravitation").get("properties");return n.Object.create(e)}).property("content"),collision:n.computed(function(){var e=this.get("content").findProperty("title","collision").get("properties");return n.Object.create(e)}).property("content"),compTypes:n.computed(function(){var e=this.get("content").findProperty("title","type").get("properties");return n.Object.create(e)}).property("content"),fonts:n.computed(function(){var e=this.get("content").findProperty("title","font").get("properties");return n.Object.create(e)}).property("content")});e.Potion=n.Object.extend({title:null,properties:null,icon:function(){var e=this.get("title");return"/editor/static/img/icons/icon-"+e+".png"}.property("title")});e.PotionView=n.View.extend({content:null,template:n.Handlebars.compile('<img {{bindAttr src="content.icon"}} {{bindAttr data-potion="content.title"}} {{bindAttr alt="title"}} class="potion-icon inner-shadow draggable-item" />')});e.Magos=n.Object.extend({user:null,magos:null,potions:[],userActiveBinding:"App.usersController.user",busy:function(){return this.getPath("user.busy")}.property("user"),icon:function(){var e=this.get("magos");return"/editor/static/img/icons/"+e+".png"}.property("magos"),activeUser:function(){var e=this.get("user"),t=this.get("userActive");return n.isEqual(e,t)}.property("user","userActive"),isArcitectus:function(){return this.get("magos")==="arcitectus"?!0:!1}.property("magos"),isArtifex:function(){return this.get("magos")==="artifex"?!0:!1}.property("magos"),isPhysicus:function(){return this.get("magos")==="physicus"?!0:!1}.property("magos"),isPrincipes:function(){return this.get("magos")==="principes"?!0:!1}.property("magos"),magosObserver:function(){console.log("magos changes");var e=this.get("user"),r=this.get("magos");setTimeout(function(){n.run.next(function(){c(t(".sortable-sidearea"))})},500)}.observes("user.magos")});e.magosesController=n.ArrayController.create({content:[],selectedBinding:"App.usersController.user.magos",updateItem:function(t,n,r){var i=this.findProperty(t,n),s=e.Magos.create(r),o=this.indexOf(i);this.replaceContent(o,1,[s])},populate:function(){var n=this,r=e.usersController.get("user"),i=r.get("magos");if(i){console.log("User has magos: "+i);var s=n.get("content").findProperty("magos",i);s.set("user",r);e.dataSource.userChangedMagos(r,i,function(e){console.log("emit (user has a magos on login)")})}else{var o=n.get("content").filterProperty("user",null),u=null;if(o.length>0){u=o[0];var a=e.Magos.create(u);console.log(a);console.log("Set user to "+u.magos);a.set("user",r);n.updateItem("magos",u.magos,a);e.dataSource.userChangedMagos(r,u.magos,function(e){console.log("emit (user assigned a magos on login)")});u.magos==="arcitectus"&&t(".chest-container").addClass("arcitectus-magos")}else alert("There are no free roles.")}},selectedObserver:function(){var n=this,r=this.get("selected"),i=e.usersController.get("user"),s=n.get("content").findProperty("user",i);if(s){console.log("Previous MAGOS found: "+s.magos);s.set("user",null)}if(r){console.log("Change user magos to: "+r);var o=n.get("content").findProperty("magos",r);console.log("newMagos:");console.log(o);o&&o.set("user",i);e.usersController.set("user.magos",r)}r!=="arcitectus"?t(".chest-container").removeClass("arcitectus-magos"):t(".chest-container").addClass("arcitectus-magos")}.observes("selected")});e.MagosView=n.View.extend({contentBinding:"App.magosesController.content",classNames:["sidebar","sortable-sidearea"],didInsertElement:function(){var e=this.$();e.sortable();n.run.next(function(){c(e)})},busyObserver:function(){return n.run.next(function(){return n.run.next(function(){t(".busy-icon").tooltip({delay:{show:500,hide:100},placement:"left"})})})}.observes("content.@each.busy"),selectedObserver:function(){}.observes("content.selected")});e.MagosComponentPropertyView=n.View.extend({contentBinding:"App.potionsController.content",controlsBinding:"App.potionsController.controls",gravitationBinding:"App.potionsController.gravitation",collisionBinding:"App.potionsController.collision",compTypesBinding:"App.potionsController.compTypes",fontsBinding:"App.potionsController.fonts",scoreBinding:"App.potionsController.score",controlsMethodBinding:"App.potionsController.controls.method",speedBinding:"App.potionsController.controls.speed",jumpHeightBinding:"App.potionsController.controls.jumpHeight",gridBinding:"App.potionsController.controls.grid",collisionEventBinding:"App.potionsController.collisions.event",collisionTargetBinding:"collision.target",collisionScoreBinding:"collision.score",strengthBinding:"gravitation.strength",compTypeBinding:"compTypes.title",familyBinding:"fonts.family",fontSizeBinding:"fonts.size",fontColorBinding:"fonts.color",fontBackgroundBinding:"fonts.background",selectedCollisionTarget:null,selectedCollisionEvent:null,selectedScoreScore:null,cancelFormSubmit:function(e){e.preventDefault();p()},submitScoresProperties:function(t){t.preventDefault();var n=e.gameComponentsController.get("selectedScoreTarget"),r=e.gameComponentsController.get("selectedScoreEvent"),i=this.get("selectedScoreScore"),s=n?n.slug:null,o=e.selectedComponentController.getPath("content.properties.collisions"),u=!1;o&&_.each(o,function(t){if(t.target.slug==s&&t.event.event==r.event){t=e.Collision.create({target:t.target,event:t.event,score:i});console.log("SCORE ADDED FOR COLLISION!");u=!0}});if(u){var a=e.selectedComponentController.get("content"),f=e.selectedComponentController.getPath("content.slug");e.dataSource.saveGame(0,function(e){console.log("save (edit score properties)")});e.dataSource.updateGameComponent(f,a,function(e){console.log("emit (update game component score properties)")})}},submitCollisionProperties:function(t){t.preventDefault();var n=e.gameComponentsController.get("selectedCollisionTarget");console.log(e.potionsController.get("controls").method.method);var i=e.gameComponentsController.get("selectedCollisionEvent"),s=n?n.slug:null,o={slug:n.slug,title:n.title},u=e.Collision.create({target:o,event:i,score:null});e.selectedComponentController.getPath("content.properties.collisions")===r?e.selectedComponentController.setPath("content.properties.collisions",[u]):e.selectedComponentController.getPath("content.properties.collisions").pushObject(u);var a=e.selectedComponentController.get("content"),f=e.selectedComponentController.getPath("content.slug");e.dataSource.saveGame(0,function(e){console.log("save (edit properties)")});e.dataSource.updateGameComponent(f,a,function(e){console.log("emit (update game component properties)")})},submitGravitationProperties:function(n){n.preventDefault();var r=t(".gravitationStrengthVal"),i=r.val(),s={strength:i};e.selectedComponentController.setPath("content.properties.gravitation",s);var o=e.selectedComponentController.get("content"),u=e.selectedComponentController.getPath("content.slug");e.dataSource.saveGame(0,function(e){console.log("save (edit properties)")});e.dataSource.updateGameComponent(u,o,function(e){console.log("emit (update game component properties)")})},submitFontProperties:function(t){t.preventDefault();var n=this.getPath("family"),r=this.getPath("fontSize"),i=this.getPath("fontColor"),s=this.getPath("fontBackground"),o={size:r,family:n,color:i,background:s};e.selectedComponentController.setPath("content.properties.font",o);var u=e.selectedComponentController.get("content"),a=e.selectedComponentController.getPath("content.slug");e.dataSource.saveGame(0,function(e){console.log("save (edit properties)")});e.dataSource.updateGameComponent(a,u,function(e){console.log("emit (update game component properties)")})},submitCompTypeProperties:function(t){t.preventDefault();var n=this.getPath("compType.title");e.selectedComponentController.setPath("content.properties.type",n);var r=e.selectedComponentController.get("content"),i=e.selectedComponentController.getPath("content.slug");e.dataSource.saveGame(0,function(e){console.log("save (edit properties)")});e.dataSource.updateGameComponent(i,r,function(e){console.log("emit (update game component properties)")})},submitControlsProperties:function(
t){t.preventDefault();var n=this.getPath("controlsMethod.method"),r=this.getPath("speed"),i=this.getPath("jumpHeight"),s={method:n,speed:r,jumpHeight:i};e.selectedComponentController.setPath("content.properties.controls",s);var o=e.selectedComponentController.get("content"),u=e.selectedComponentController.getPath("content.slug");e.dataSource.saveGame(0,function(e){console.log("save (edit properties)")});e.dataSource.updateGameComponent(u,o,function(e){console.log("emit (update game component properties)")})},removeComponentProperty:function(e){e.preventDefault();var r=t(e.target),i=r.closest(".ember-view"),s=n.View.views[i.attr("id")],o=s.get("content");delete o.score},controlsMethodObserver:function(){this.getPath("controlsMethod.method")!="twoway"?e.potionsController.set("hideJumpHeight",!0):e.potionsController.set("hideJumpHeight",!1)}.observes("controlsMethod"),openImageAssetsDialog:function(){event.preventDefault();t("#image-assets").modal().on("show")}});e.setFlash=function(e,t){n.flashQueue.pushFlash(e,t)};e.PotionsControlsView=Ember.View.extend({contentBinding:"App.selectedComponentController.content",methodBinding:"App.selectedComponentController.content.properties.controls.method",save:function(e){e.preventDefault();e.stopPropagation();this.set("method",this.get("textField").getCurrentValue())}});var i=e.InfoBoxView=n.View.create({templateName:"infobox-view"});e.InfoBoxControlsView=n.View.extend({contentBinding:"App.selectedComponentController.content.properties.controls",showJumpHeight:!1,contentObserver:function(){var e=this.getPath("content.properties.controls.method");!_.isUndefined(e)&&e=="twoway"?this.set("showJumpHeight",!0):this.set("showJumpHeight",!1);var t=this.get("showJumpHeight")}.observes("content")});e.InfoBoxCollisionView=n.View.extend({contentBinding:"App.selectedComponentController.content.properties.collisions",removeCollision:function(t){var n=t.context;e.selectedComponentController.getPath("content.properties.collisions").removeObject(n);var r=e.selectedComponentController.get("content"),i=e.selectedComponentController.getPath("content.slug");e.dataSource.saveGame(0,function(e){console.log("save (remove collision)")});e.dataSource.updateGameComponent(i,r,function(e){console.log("emit (update game component properties)")})}});e.InfoBoxGravitationView=n.View.extend({contentBinding:"App.selectedComponentController.content.properties.gravitation",removeGravitation:function(t){e.selectedComponentController.setPath("content.properties.gravitation",null);var n=e.selectedComponentController.get("content"),r=e.selectedComponentController.getPath("content.slug");e.dataSource.saveGame(0,function(e){console.log("save (remove gravitation)")});e.dataSource.updateGameComponent(r,n,function(e){console.log("emit (update game component properties)")})}});e.InfoBoxScoreView=n.View.extend();e.InfoBoxDialogView=n.View.extend();e.InfoBoxTextView=n.View.extend();e.InfoBoxSpriteView=n.View.extend();e.InfoBoxAnimationView=n.View.extend();e.InfoBoxAudioView=n.View.extend();e.InfoBoxTypeView=n.View.extend();e.InfoBoxFontView=n.View.extend({tagName:"div",classNames:["font-preview"],contentBinding:"App.selectedComponentController.content",familyBinding:"App.selectedComponentController.content.properties.font.family",sizeBinding:"App.selectedComponentController.content.properties.font.size",colorBinding:"App.selectedComponentController.content.properties.font.color",bgColorBinding:"App.selectedComponentController.content.properties.font.background",cssFamily:"",cssSize:"",cssColor:"",cssBgColor:"",attributeBindings:["style"],familyObserver:function(){this.set("cssFamily","font-family:"+this.get("family")+";")}.observes("family"),sizeObserver:function(){this.set("cssSize","font-size:"+this.get("size")+"px;")}.observes("size"),colorObserver:function(){this.set("cssColor","color:"+this.get("color")+";")}.observes("color"),bgcolorObserver:function(){this.set("cssBgColor","background-color:"+this.get("bgColor")+";")}.observes("bgColor")});e.ComponentType=n.Object.extend({name:null});e.componentTypesController=n.ArrayController.create({selected:null,content:[e.ComponentType.create({name:"Block"}),e.ComponentType.create({name:"Collectible"}),e.ComponentType.create({name:"Player"}),e.ComponentType.create({name:"Pushable"}),e.ComponentType.create({name:"Decoration"})]});var s=n.View.create({templateName:"shoutbox-view"});e.Shout=n.Object.extend({timestamp:"",writer:"",magos:"",message:"",time:function(){var e=new Date(this.get("timestamp")*1e3),t=e.getHours(),n=e.getMinutes(),r=e.getSeconds();t<10&&(t="0"+t);n<10&&(n="0"+n);r<10&&(r="0"+r);return t+":"+n+":"+r}.property("timestamp")});e.shoutsController=n.ArrayController.create({content:[e.Shout.create({timestamp:Math.round((new Date).getTime()/1e3),firstName:"Superioux",userName:"Superioux",magos:"superioux",message:"Welcome to Magos"})]});e.ShoutsView=n.View.extend({tagName:"table",contentBinding:"App.shoutsController.content",didInsertElement:function(){this.scroll()},contentObserver:function(){var e=this;n.run.next(function(){e.scroll()})}.observes("content.@each"),scroll:function(){var e=this.$().parent();e.scrollTop(e.prop("scrollHeight"))}});e.ShoutForm=n.View.extend({tagName:"form",classNames:["form-inline"],controller:null,textField:null,firstNameBinding:"App.usersController.user.firstName",userNameBinding:"App.usersController.user.userName",magosBinding:"App.usersController.user.magos",slugBinding:"App.gameController.content.slug",submit:function(t){t.preventDefault();var n=this.getPath("textField.value");if(!n.length)return;var r=Math.round((new Date).getTime()/1e3),i={timestamp:r,firstName:this.firstName,userName:this.userName,magos:this.magos,message:n},s=e.Shout.create(i);e.shoutsController.get("content").pushObject(s);var o=this;i.slug=this.slug;e.dataSource.shout(i,function(e){});this.setPath("textField.value",null)}});i.appendTo(".sortable-mainarea");s.appendTo(".sortable-mainarea");e.TitleView=n.View.extend({tagName:"a",classNames:["brand"],attributeBindings:["href"],titleBinding:n.Binding.oneWay("App.gameController.content.title"),hrefBinding:n.Binding.oneWay("App.gameController.content.href")});e.PublishedView=n.View.extend({classNames:["btn-group","btn-group-state"],classNameBindings:["privateState","publicState"],stateBinding:n.Binding.oneWay("App.gameController.content.state"),alwaysTrue:!0,privateState:!1,publicState:!0});e.EmptySettingsView=n.View.extend({templateName:"empty-settings",template:n.Handlebars.compile('<h4 style="margin: 8px 0;">No Settings</h4>')});e.ImageAssetsView=n.View.extend({tagName:"ul",classNames:["assets-list"]});e.DataSource=n.Object.extend({setUserCredentials:function(e){var n=t.cookie("sessionid"),r=t.cookie("csrftoken"),i=window.location.pathname.split("/"),s=_.last(i),o={sessionid:n,csrftoken:r,slug:s};f.emit("setUserCredentials",o,function(t){e(t)})},joinRoom:function(e,t){f.emit("joinRoom",e,function(e){t(e)})},shout:function(e,t){f.emit("shout",e,function(e){t(e)})},addGameComponent:function(e,t){f.emit("addGameComponent",e,function(e){t(e)})},removeGameComponent:function(e,t){f.emit("removeGameComponent",e,function(e){t(e)})},updateGameComponent:function(e,t,n){f.emit("updateGameComponent",e,t,function(e){n(e)})},saveGameComponentToCanvas:function(e,t,n){f.emit("saveGameComponentToCanvas",e,t,function(e){n(e)})},removeGameComponentFromCanvas:function(e,t,n){f.emit("removeGameComponentFromCanvas",e,t,function(e){n(e)})},saveSceneComponentToCanvas:function(e,t,n){f.emit("saveSceneComponentToCanvas",e,t,function(e){n(e)})},removeSceneComponentFromCanvas:function(e,t,n){f.emit("removeSceneComponentFromCanvas",e,t,function(e){n(e)})},addUser:function(e,t){f.emit("addUser",e,function(e){t(e)})},userChangedMagos:function(e,t,n){console.log("EMIT USER CHANGED MAGOS");console.log(e);console.log(e.get("magos"));console.log(t);f.emit("userChangedMagos",e,t,function(e){n(e)})},canUserChangeMagos:function(e,t,n,r){console.log("EMIT CAN USER CHANGE MAGOS");console.log(t);console.log(n);f.emit("canUserChangeMagos",e,t,n,function(e){r(e)})},saveGame:function(t,n){var r=e.gameController.get("content");f.emit("saveGame",t,r,function(e){n(e)})},getSkillsets:function(t){f.emit("getSkillsets","",function(n){var r=[],i=[];_.each(n,function(t){var n=[];_.each(t.potions,function(t){var r=e.Potion.create({title:t.title,properties:t.properties});e.potionsController.get("content").pushObject(r);i.push(r);n.push(r)});r.push(e.Magos.create({magos:t.magos,potions:n}))});t(r)})},getSceneComponents:function(t){f.emit("getSceneComponents","",function(n){var r=[];_.each(n,function(t){r.push(e.SceneComponent.create({slug:t.slug,title:t.title,sprite:t.sprite,scenes:t.scenes,potions:t.potions}))});t(r)})},getLanguages:function(t){f.emit("getLanguages","",function(n){var r=[];_.each(n,function(t){r.push(e.Language.create({title:t.title,slug:t.slug,code:t.code}))});t(r)})},getImageAssets:function(t,n,r){var i=n||null,s=null,o=null,u=null,a=null,l=e.gameController.getPath("content.revision.canvas");if(r==="background"){u=l.blockSize*l.columns;a=l.blockSize*l.rows}else{u=l.blockSize;a=l.blockSize}f.emit("getImageAssets",i,u,a,s,o,function(n){var r=[];_.each(n,function(t){r.push(e.ImageAsset.create({name:t.name,slug:t.slug,file:t.file,ext:t.ext,state:t.state,type:t.type}))});t(r)})},joinGame:function(t){f.emit("joinGame",function(n){if(n){var r=e.Game.create();console.log(n);r.set("title",n.title);r.set("slug",n.slug);r.set("type",n.type);r.set("state",n.state);r.set("cloned",n.cloned);r.set("href",window.location.href);var i=[];_.each(n.authors,function(t){var n=e.User.create({userName:t.userName,firstName:t.firstName,lastName:t.lastName,magos:t.magos});i.push(n)});r.set("authors",i);var s=n.revision;_.isString(s)&&(s=JSON.parse(s));var o=[];_.each(s.gameComponents,function(t){console.log(t);console.log(t.properties);o.push(e.GameComponent.create({title:t.title,slug:t.slug,properties:t.properties}))});var u=[];_.each(s.scenes,function(t){var n=[];_.each(t.sceneComponents,function(t){console.log(t.oid);n.push(e.CanvasComponent.create({slug:t.slug,position:t.position,oid:t.oid,properties:t.properties}))});var r=[];_.each(t.gameComponents,function(t){r.push(e.CanvasComponent.create({slug:t.slug,position:t.position,oid:t.oid}))});var i=e.Scene.create({name:t.name,sceneComponents:n,gameComponents:r});u.push(i)});var a=[],f=[],l=e.Revision.create({canvas:s.canvas,scenes:u,audios:a,sprites:f,gameComponents:o});r.set("revision",l);t(r)}else{console.log("Game not found.");window.location.replace("http://localhost:8080")}})}});e.dataSource=e.DataSource.create({store:e.store});e.Store=n.ArrayProxy.extend({});var o=window.location.pathname,u=o.replace(/^\/editor\//,"").replace(/\/$/,""),a="http://"+window.location.hostname,f=io.connect(a,{resource:"editor/socket.io"});f.on("connecting",function(){console.log("websocket connecting (editor)")});f.on("connect_failed",function(e){console.error("unable to connect to server (editor)",e)});f.on("connect",function(){console.log("websocket connected (editor)");e.gameController.populate()});f.on("foobar",function(t){console.log(t);e.setFlash("notice","User "+t.userName+" requests Magos change from "+t.magos)});f.on("shout",function(t){_.isObject(t)&&e.shoutsController.get("content").pushObject(e.Shout.create(t))});f.on("addGameComponent",function(t){console.log(">>> SOCKET REQUEST: addGameComponent");_.isObject(t)&&e.gameComponentsController.get("content").pushObject(e.GameComponent.create(t))});f.on("removeGameComponent",function(t){console.log(">>> SOCKET REQUEST: removeGameComponent");e.gameComponentsController.removeItem("slug",t)});f.on("updateGameComponent",function(t,n){console.log(">>> SOCKET REQUEST: updateGameComponent");e.gameComponentsController.updateItem("slug",t,n)});f.on("saveGameComponentToCanvas",function(e,t){console.log(">>> SOCKET REQUEST: saveGameComponentToCanvas");y(e,t)});f.on("removeGameComponentFromCanvas",function(e,t){console.log(">>> SOCKET REQUEST: removeGameComponentFromCanvas");g(e,t)});f.on("addUser",function(t){console.log(">>> SOCKET REQUEST: addUser");console.log(t);_.isObject(t)&&(e.usersController.get("content").findProperty("userName",t.userName)||e.usersController.get("content").pushObject(e.User.create(t)))});f.on("disconnectUser",function(t){var n=t.userName,r=t.magos;console.log(">>> SOCKET REQUEST: disconnectUser");console.log(n);console.log(r);e.usersController.removeItem("userName",n);var r=e.magosesController.get("content").findProperty("magos",r);console.log(r);_.isObject(r)&&r.set("user",null)});f.on("userChangedMagos",function(t){console.log(">>> SOCKET REQUEST: userChangedMagos");var n=t.user,r=t.newMagos,i=t.oldMagos;console.log(t);if(!_.isNull(i)&&i!=r){var s=e.magosesController.get("content").findProperty("magos",i);if(_.isObject(s)){console.log("Old magos removed from user");s.set("user",null)}}var o=e.magosesController.get("content").findProperty("magos",r);console.log(o.user);if(!o.user){o.set("user",n);console.log("new magos "+r+" assigned to "+n.userName)}else console.log("magos already in use")});f.on("refreshRevision",function(t){if(_.isObject(t)){console.log(t);console.log(t.revision);var n=t.revision;_.isString(n)&&(n=JSON.parse(n));var r=[];_.each(n.gameComponents,function(t){console.log(t);r.push(e.GameComponent.create({title:t.title,slug:t.slug,properties:t.properties}))});var i=[];_.each(t.revision.scenes,function(t){var n=[];_.each(t.gameComponents,function(t){n.push(e.CanvasComponent.create({slug:t.slug,position:t.position,oid:t.oid}))});var r=e.Scene.create({name:t.name,sceneComponents:[],gameComponents:n});i.push(r)});var s=[],o=[],u={canvas:t.revision.canvas,scenes:i,audios:t.audios,sprites:t.sprites,gameComponents:r};e.gameController.get("content").set("revision",e.Revision.create(u));d()}});t(document).on("click tap",".btn-grid",function(e){e.preventDefault();var n=t(e.target).closest(".btn");t(".canvas .canvas-table").toggleClass("gridless");n.toggleClass("active")});t(document).on("click tap",".btn-group-theme .btn",function(e){e.preventDefault();var n=t(e.target).closest(".btn");n.siblings().removeClass("active");n.addClass("active");var r=n.data("theme"),i="/editor/static/css/"+r+".css";t(document).find("#theme").attr("href",i)});t(document).on("click tap",".btn-play",function(e){e.preventDefault();var n=t(e.target).closest("td").find("audio")[0];n.play()});t(document).on("click tap",".btn-preview",function(n){n.preventDefault();var r=t("#dialog-preview");if(!r.hasClass("styled")){var i=e.revisionController.content.canvas,s=i.rows,o=i.columns,a=i.blockSize,f=15+a*o+15,l=134+a*s,c=a*s;r.css({width:f+"px",height:l+"px"});r.find(".modal-body").css({height:c+"px"});r.addClass("styled")}r.one("show",function(){var e=document.getElementById("preview").contentWindow;e.postMessage(u,window.location.protocol+"//"+window.location.host)});r.find("button").on("click tap",function(e){r.modal("hide")});r.modal()});t(document).on("click tap",".btn-back-potion",function(t){t.preventDefault();e.usersController.getPath("user.busy")&&e.usersController.setPath("user.busy",!1);p()});t(".sortable-mainarea").sortable({placeholder:"sortable-highlight",items:"> .ember-view:not(:first)",handle:".sortable-handle",axis:"y",opacity:.8,forceHelperSize:!0});t(".sortable-mainarea").disableSelection();t(document).on("click tap",".btn-group-help .btn",function(e){e.preventDefault();var n=t(e.target).closest(".btn");n.toggleClass("active");t("body").toggleClass("help");t("body").popover({selector:".help .help-popover",placement:"bottom",delay:{show:500,hide:100}})});var w=function(e){var t=e.trim();t=t.replace(/[^a-z0-9_-]/gi,"-").toLowerCase();t=t.replace(/-+/gi,"-");t=t.replace(/^-/,"");t=t.replace(/-$/,"");return t}})(window.App=window.App||Em.Application.create(),jQuery,window.Em)});