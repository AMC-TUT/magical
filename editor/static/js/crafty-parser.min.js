function capitaliseFirstLetter(e){e=e.toLowerCase();return e.charAt(0).toUpperCase()+e.slice(1)}function changeScore(e){Parser.settings.score+=e;Crafty("score").each(function(){this.text("Score: "+Parser.settings.score)})}function handleCollision(e,t,n){_.each(e.collisions,function(n){if(n.target.slug==t.slug){var r=n.event.event,i=!_.isNull(n.score)&&!_.isUndefined(n.score)?parseInt(n.score,10):0;r==="destroySelf"?e.destroy():r==="destroyTarget"&&t.destroy();i&&changeScore(i)}})}var isiPad=navigator.userAgent.match(/iPad/i)!==null,Parser={game:null,socket:null,blockSize:null,settings:{djangoUri:"http://192.168.43.232/",score:0},parseGame:function(e){Parser.game=e;var t=Parser.initGame(e.revision.canvas),n=Parser.loadSprites(e.revision.gameComponents),r=Parser.loadAudios(e.revision.audios),i=Parser.createGameComponents(e.revision.gameComponents),s=Parser.createSceneComponents(e.revision.scenes),o=Parser.createScenes(e.revision.scenes);Crafty.scene("loading")},initGame:function(e){var t=e.blockSize*e.rows,n=e.blockSize*e.columns;Parser.blockSize=e.blockSize;Crafty.init(n,t).canvas.init();Crafty.background("#FFF");Crafty.magos={};Crafty.magos.audio={};Crafty.magos.audio.mute=!1;Crafty.magos.width=n;Crafty.magos.height=t;Crafty.viewport.bounds={min:{x:0,y:0},max:{x:n,y:t}};return!0},loadAudios:function(e){var t="/static/game/audios";_.each(e,function(e){var n={},r=[t+"/mp3/"+slug+".mp3",t+"/ogg/"+slug+".ogg",t+"/wav/"+slug+".wav"];n[slug]=r;Crafty.audio.add(n)});return!0},loadSprites:function(e){var t=Parser.settings.djangoUri+"game/image/",n="_"+Parser.blockSize+"x"+Parser.blockSize;_.each(e,function(e){var r="."+e.properties.ext,i=!_.isUndefined(e.properties.file)&&_.isString(e.properties.file)?e.properties.file:"";if(i.length){var s={};s[i+"-sprite"]=[0,0];Crafty.sprite(Parser.blockSize,t+i+n+r,s)}});return!0},createScenes:function(e){_.each(e,function(e){var t=_.find(e.sceneComponents,function(e){return e.slug==="background"}),n=null,r="/editor/user-media/images/",i=".png";_.isObject(t)&&_.isObject(t.properties)&&_.isString(t.properties.sprite)&&(n=r+t.properties.sprite+i);var s={font:"Architects Daughter",size:30,color:"#111111"},o={font:"Architects Daughter",size:20,color:"#3276b1"},u={font:"Architects Daughter",size:30,color:"#3276b1"},a={font:"Open Sans",size:14,color:"#111111"};Crafty.scene(e.name,function(){_.isNull(n)||Crafty.background("url("+n+")");/^(intro|outro)$/.test(e.name)&&Crafty.background("#F2F2F2");if(e.name=="intro")var t=Crafty.e("2D, DOM, Text2, TitleText").text(Parser.game.title).setStyle(s).setAlign("center").attr({x:0,y:30,w:Crafty.magos.width}),r=Crafty.e("2D, DOM, Text2").text(Parser.game.description?Parser.game.description:"").setStyle(a).setAlign("center").attr({x:20,y:100,w:Crafty.magos.width-40}),i=Crafty.e("Button, Text2, StartButton").text("Start").setStyle(s).setAlign("center").button(function(){Crafty.scene("game")}).attr({w:200,h:50,x:Crafty.magos.width/2-100,y:Crafty.magos.height-80});if(e.name=="outro")var f=Crafty.e("2D, DOM, Text2, TitleText").text("Game Over").setStyle(s).setAlign("center").attr({x:0,y:30,w:Crafty.magos.width}),l=Crafty.e("2D, DOM, Text2, ScorePoints, OutroText").text("Score: "+Parser.settings.score).setStyle(u).setAlign("center").attr({h:30,x:20,y:100,w:Crafty.magos.width-40}),c=Crafty.e("Button, Text2, StartButton, BackButton").text("Back").setStyle(s).setAlign("center").button(function(){Crafty.scene("intro")}).attr({w:200,h:50,x:Crafty.magos.width/2-100,y:Crafty.magos.height-80});if(e.name=="game"){var h=Crafty.e("Button, Text2, StartButton, XButton").text("x").setStyle(o).setAlign("center").button(function(){Crafty.scene("outro")}).attr({w:20,h:20,x:Crafty.magos.width-22,y:2});Parser.settings.score=0;var p=Crafty.e("2D, DOM, Text2, ScorePoints, GameText").text("Score: "+Parser.settings.score).setStyle(o).attr({h:20,w:150,x:5,y:2})}_.each(e.sceneComponents,function(e){var t=e.position.left,n=e.position.top;e.slug==="volume"&&Crafty.e(e.slug).attr({x:t,y:n});if(e.slug==="highscore"){var r=Crafty.e(e.slug).attr({x:t,y:n});if(_.isObject(e.properties)&&_.isObject(e.properties.font)){var i=e.properties.font;_.isUndefined(i.color)||r.css("color",i.color);_.isUndefined(i.family)||r.css("font-family",i.family);_.isUndefined(i.size)||r.css("font-size",i.size);if(!_.isUndefined(i.background)){r.css("background-color",i.background);r.css("text-shadow","1px 1px 1px "+i.background);r.css("border","1px solid "+i.background)}}}});_.each(e.gameComponents,function(e){var t=e.position.column*Parser.blockSize,n=e.position.row*Parser.blockSize;Crafty.e(e.slug).attr({x:t,y:n,w:Parser.blockSize,h:Parser.blockSize})})})});Crafty.scene("loading",function(){$("#cr-stage").css("background","#F2F2F2");var e=Parser.game.revision.canvas.columns*Parser.game.revision.canvas.blockSize;Crafty.e("HTML").append('<div style="width:'+e+'px;" class="loader">'+' <img src="'+Parser.settings.djangoUri+'static/img/magos-m-black.png" class="loader-logo" />'+' <p class="loader-procent" style="color: #000;">0%</p>'+" </div>");var t=[],n="/editor/",r="/editor/user-media/images/",i=".png";_.each(Parser.game.revision.gameComponents,function(e){!_.isUndefined(e.properties.file)&&_.isString(e.properties.file)&&t.push(Parser.settings.djangoUri+"game/image/"+e.properties.file+"_"+Parser.blockSize+"x"+Parser.blockSize+"."+e.properties.ext)});Crafty.load(t,function(){setTimeout(function(){Crafty.scene("intro")},700)},function(e){$(".loader-procent").text(Math.round(e.percent)+"%")},function(e){alert("Error loading "+e.src+" while loading game assets (loaded "+e.loaded+" of "+e.total+")")})});return!0},createGameComponents:function(e){_.each(e,function(e){var t=e.properties,n=_.isString(t.file)?t.file:!1,r=Crafty.c(e.slug,{init:function(){var r=this;r.addComponent("2D","Canvas","Image");r.slug=e.slug;var i=capitaliseFirstLetter(e.slug);r.addComponent(i);n&&!n.match(/^empty/)&&r.addComponent(n+"-sprite");if(!_.isUndefined(t.controls)){var s=_.isNumber(t.controls.speed)?t.controls.speed:4;r.attr({z:100});if(t.controls.method.toLowerCase()==="twoway"){var o=_.isNull(t.controls.jumpHeight)?12:parseInt(t.controls.jumpHeight);r.addComponent("Twoway","Keyboard","Gravity","Collision");r.twoway(s,o);r.gravity("platform")}if(t.controls.method.toLowerCase()==="fourway"){r.addComponent("Fourway","Keyboard");r.fourway(s)}if(t.controls.method.toLowerCase()==="multiway"){r.addComponent("Multiway","Keyboard");r.multiway(s,{UP_ARROW:-90,DOWN_ARROW:90,RIGHT_ARROW:0,LEFT_ARROW:180})}}if(_.isString(t.type)){r.addComponent(t.type);t.type.toLowerCase()==="platform"&&r.addComponent("platform");if(t.type.toLowerCase()==="block"){r.addComponent("platform");r.addComponent("Solid");r.addComponent("Collision")}if(t.type.toLowerCase()==="pushable"){r.addComponent("platform");r.addComponent("Solid");r.addComponent("Collision");r.addComponent("Pushable")}if(t.type.toLowerCase()==="player"){r.addComponent("Player");r.addComponent("Collision");r.direction=""}}if(!_.isUndefined(t.gravitation)&&!_.isNull(t.gravitation)&&!_.isNull(t.gravitation.strength)){r.addComponent("Gravity");r.gravity("platform");r.gravityConst(parseFloat(t.gravitation.strength))}r.bind("EnterFrame",function(e){this._x>Crafty.viewport.width||this._x<0||this._y>Crafty.viewport.height||this._y<0;this._x>Crafty.viewport.width-Parser.blockSize&&(this.x=Crafty.viewport.width-Parser.blockSize);this._x<0&&(this.x=0);this._y>Crafty.viewport.height-Parser.blockSize&&(this.y=Crafty.viewport.height-Parser.blockSize);this._y<0&&(this.y=0)});if(_.isArray(t.collisions)){r.addComponent("Collision");r.collisions=t.collisions;_.each(t.collisions,function(e){if(_.isObject(t.collisions[0])){var n=e.target,i=e.event;r.onHit(n.slug,function(e){var t=e[0].obj;handleCollision(r,t)})}})}r.bind("Moved",function(e){if(this.has("Collision")){var t=this.hit("Pushable");if(t){var n=this._x>e.x?"left":"right",r=this._x,i=this._w,s=r+i;_.each(t,function(e){var t=e.obj;if(n=="left"){var i=s-t._x;t.attr({x:t._x+i})}else{var i=t._x+t._w-r;t.attr({x:t._x-i})}})}this.hit("Solid")&&this.attr({x:e.x,y:e.y})}})}})});return!0},createSceneComponents:function(e){var t="/static/img/icons/",n=".png";_.each(e,function(e){_.each(e.sceneComponents,function(e){e.slug==="volume"&&Crafty.c(e.slug,{init:function(){var r=this,i=_.isUndefined(Crafty.magos.volume)||Crafty.magos.volume?"":"-off";r.addComponent("2D","DOM","Image");r.image(t+"icon-"+e.slug+i+n);r.addComponent("volume-button")}});e.slug==="highscore"&&Crafty.c(e.slug,{init:function(){var e=this;e.addComponent("2D","DOM");Parser.getHighscores()}})})});return!0},getHighscores:function(){var e=Parser.game.slug;socket.emit("getHighscore",e,function(e){if(_.isObject(e)){var t="<h2>TOP5</h2>";t+="<ol>";_.each(e.results,function(e){t+="<li>"+e.score+" "+e.firstName+" "+e.lastName+"</li>"});t+="</ol>";$("#cr-stage").find(".highscore").empty().append(t)}})},getGame:function(e,t){socket=t;socket.emit("joinGame",function(e){Parser.parseGame(e)})},getAnimation:function(e,t){var n=_.find(e,function(e){return e.key===t});return n.animation},setAnimation:function(e,t){e.addComponent(t.id);e.animate(id,0,0,0);e.animate(id,15,1);return e}};