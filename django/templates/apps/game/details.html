{% extends "apps/game/game_base.html" %}
{% load i18n %}

{% block bodyclass %}home{% endblock %}

{% block content %}
    
                    
        <div id="main-content">
        {% if game %}
                       
            <h1>{{ game.title }}</h1>
            {% if game.image %}
            <img src="{{ MEDIA_URL }}{{ game.image }}" class="game-image embedded">
            {% else %}
            <img src="{{ STATIC_URL }}img/default-game-image.png" class="game-image embedded">
            {% endif %}

            {% if game.creator %}
            <p>Created by {{ game.creator.username }}</p>
            {% endif %}
        
            {% if can_review %}
                <input type="range" value="{{ avg_stars }}" step="1" id="ratingSettings">
                <div class="rateit" data-gameid="{{ game.id }}" data-rateit-backingfld="#ratingSettings" data-rateit-min="0" data-rateit-max="5">
                </div>
                <div class="reviewInfo">({{ avg_stars }} average, {{ num_reviews }} votes)</div>
                <div id="response"></div>
            {% endif %}
            <p><a class="btn btn-primary" id="play-game" href="{{ play_url }}{{ game.slug }}" target="_blank">Play game</a></p>

            <hr />

            <p>{{ game.description }}</p>
            
            <hr />
            
            <div id="game-authors"></div>
            
            <div id="available-authors"></div>

            <hr />

            <p>Game created on {{ game.created }}</p>
            <p>Played 0 times</p>

            <hr />

            <h2>Comments</h2>
            <p><i>No comments yet.</i></p>
        
            {% if can_edit %}
            <hr />
            <h2>Edit {{ game.title }}</h2>
            <p><a class="btn btn-primary" href="{{ editor_url }}{{ game.slug }}" target="_blank">Launch game editor</a> (in a new window)</p>
            {% endif %}
            
        {% endif %}
        </div>
    
        <div id="sidebar">
            <h2>Highscore</h2>
            {% if highscores %}
            <ol class="highscore-list">
            {% for highscore in highscores %}
                <li><span class="highscore_name">{{ highscore.user.first_name }} {{ highscore.user.last_name }}</span><span class="highscore_score">{{ highscore.score }}</span></li>
            {% endfor %}
            </ol>
            {% else %}
            <p>No highscore yet.</p>
            {% endif %}

            <h2>Get Help</h2>
            <p>Watch Magos tutorial videos to master the magical skills.</p>
            <iframe width="300" height="169" src="http://www.youtube.com/embed/I8qkQhTfSJ4" frameborder="0" allowfullscreen></iframe>

		    <h3>Latest Discussion</h3>
            <ul>
                <li>Cum sociis natoque penatibus et magnis dis</li>
                <li>Parturient montes, nascetur ridiculus mus</li>
                <li>Mauris posuere, lorem sit amet iaculis laoreet</li>
                <li>Lectus dui faucibus lectus, vitae sagittis velit magna a augue</li>
            </ul>

            <h3>Lorem Ipsum</h3>
            <p>Fusce semper pulvinar libero at commodo. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus.</p>
            <p> Mauris posuere, lorem sit amet iaculis laoreet, lectus dui faucibus lectus, vitae sagittis velit magna a augue. Sed iaculis, nisi sed tincidunt molestie.</p>

        </div>

{% endblock %}

{% block extrajs %}
<script>
var gameId = {{ game.id }},
    gameSlug = '{{ game.slug }}';

$(document).ready(function() {
	
    function redirectToLogin() {
    	window.location.href = '{{ login_url }}';
    }
    
	// Django Ajax CSRF token setup
	$.ajaxSetup({
	     beforeSend: function(xhr, settings) {
	         function getCookie(name) {
	             var cookieValue = null;
	             if (document.cookie && document.cookie != '') {
	                 var cookies = document.cookie.split(';');
	                 for (var i = 0; i < cookies.length; i++) {
	                     var cookie = jQuery.trim(cookies[i]);
	                     // Does this cookie string begin with the name we want?
	                 if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                     cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                     break;
	                 }
	             }
	         }
	         return cookieValue;
	         }
	         if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
	             // Only send the token to relative URLs i.e. locally.
	             xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
	         }
	     }
	});


    $('#main-content .rateit').bind('rated reset', function (e) {
        var ri = $(this);
        //if reset is pressed, it will get value: 0.
        var value = ri.rateit('value');
        var gameId = ri.data('gameid'); // if the product id was in some hidden field: ri.closest('li').find('input[name="productid"]').val()
         // disable voting
        //ri.rateit('readonly', true);
 
        $.ajax({
            dataType : 'json',
            url : '/game/rate/' + gameId + '/' + value,
            type: 'POST',
            success: function (data) {
                if (data.hasOwnProperty('not_authenticated')) {
                    redirectToLogin();
                    return;
                }

                 //$('#response').append('<li>' + data + '</li>');
            },
            error: function (jxhr, msg, err) {
                 $('#response').append('<li style="color:red">' + msg + '</li>');
            }
        });
    });


    function bindAddAuthorSubmit() {
        $('form#add-author-to-game').on('submit', function(e) {
            e.preventDefault();
            var url = $(this).attr('action');
            var formData = $(this).serializeArray();
            var xhr = $.ajax({
                dataType : 'html',
                type: 'POST',
                data: formData,
                url : url
            });
            xhr.done(function(data) {
                getGameAuthors();
                getAvailableAuthors();
            });
        });
    }


    function bindRemoveAuthors() {
        $('.remove-author').on('click', function(e) {
            var username = $(this).data('username');
            $.ajax({
                dataType : 'json',
                url : '/game/remove-author/' + gameSlug + '/' + username,
                type: 'GET',
                success: function (data) {
                    getGameAuthors();
                },
                error: function (jxhr, msg, err) {
                }
            });
        });    
    }


    function getAvailableAuthors() {
        var xhr = $.ajax({
            dataType : 'html',
            url : '/game/available-authors/' + gameSlug,
            type: 'GET'
        });
        xhr.done(function(data) {
            $('#available-authors').html(data);
            bindAddAuthorSubmit();
        });
    }


    function getGameAuthors() {
        var xhr = $.ajax({
            dataType : 'html',
            url : '/game/game-authors/' + gameSlug,
            type: 'GET'
        });
        xhr.done(function(data) {
            $('#game-authors').html(data);
            bindRemoveAuthors();
            getAvailableAuthors();
        });
    }


    function bindPlayGame() {
        $('#play-game').on('click', function(e) {
            e.preventDefault();
            var url = $(this).attr('href');
            console.log(url);
        });
    }

    getGameAuthors();
    bindPlayGame();

}); // document ready
</script>
{% endblock %}
